<script>
(function($) {
  var ProductMediaSlider = {
    swatchOptionId: null,
    flexsliderContainer: $('#flexslider'),

    /**
     * [init description]
     * @return {[type]} [description]
     */
    init: function() {
      ProductMediaSlider.swatchLink = $('.swatch-link');

      ProductMediaSlider.bindSwatches();
      ProductMediaSlider.initFlexslider();
    },

    /**
     * [initFlexslider description]
     * @return {[type]} [description]
     */
    initFlexslider: function() {
      ProductMediaSlider.flexsliderContainer.removeData("flexslider");
      ProductMediaSlider.flexsliderContainer.flexslider({
        animation: "slide",
        controlNav: false,
        slideshow: false,
        before: function() {
          ProductMediaSlider.destroyZoom();
        },
        after: function() {
          ProductMediaSlider.createZoom($('.flex-active-slide img'));
        },
      });
    },

    /**
     * [bindSwatches description]
     * @return {[type]} [description]
     */
    bindSwatches: function() {
      ProductMediaSlider.swatchLink.on('click', function() {
        ProductMediaSlider.swatchOptionId = $(this).attr('id').slice(6);
        ProductMediaSlider.setSlides();
      });
    },

    /**
     * [setSlides description]
     */
    setSlides: function() {
      var output = ProductMediaSlider.prepareSlidesHtml();
      ProductMediaSlider.smartReplace(ProductMediaSlider.flexsliderContainer, output);
      ProductMediaSlider.initFlexslider();
    },

    /**
     * [prepareSlidesHtml description]
     * @return {[type]} [description]
     */
    prepareSlidesHtml: function() {
      var images = ProductMediaSlider.getSlidesSrc();
      var output = '<ul class="slides product-image-gallery">';
      $.each(images, function(index, value) {
        output += '<li><img id="image-' + value.img_id +'" src="' + value.src +'" class="gallery-image lazyautosizes lazyloaded" data-zoom-image="' + value.zoom + '"></li>';

      });
      output += '</ul>';
      return output;
    },

    /**
     * Get the url source of all the slides for the selected color
     * @return {[type]} [description]
     */
    getSlidesSrc: function() {
      return AssociatedProductImages.products.filter(function(product) {
        if (product.swatch === ProductMediaSlider.swatchOptionId) {
          return product;
        }
      })[0].images;
    },

    /**
     * [smartReplace description]
     * @param  {[type]} block       [description]
     * @param  {[type]} replacement [description]
     * @return {[type]}             [description]
     */
    smartReplace: function(block, replacement) {
      block.wrapInner("<div class='death-row'></div>");
      block.append(replacement);
      $('.death-row').remove();
    },
    /**
     * [createZoom description]
     * @param  {[type]} image [description]
     * @return {[type]}       [description]
     */
    createZoom: function(image) {
        if(
            // Don't use zoom on devices where touch has been used
            PointerManager.getPointer() == PointerManager.TOUCH_POINTER_TYPE
            // Don't use zoom when screen is small, or else zoom window shows outside body
            || Modernizr.mq("screen and (max-width:" + bp.medium + "px)")
        ) {
            return; // zoom not enabled
        }

        if (ProductMediaSlider.isLargeImage(image)) {
          image.parents('.product-image').addClass('zoom-available');
        } else {
          image.parents('.product-image').removeClass('zoom-available');
          return;
        }
        image.elevateZoom();
    },
    destroyZoom: function() {
        $('.zoomContainer').remove();
        $('.product-image-gallery .gallery-image').removeData('elevateZoom');
    },
    /**
     * [isLargeImage description]
     * @param  {[type]}  image [description]
     * @return {Boolean}       [description]
     */
    isLargeImage: function(image) {
      if(image.length !== 1){
        return;
      }
      var widthDiff  = image[0].naturalWidth - image.width(); 
      var heightDiff = image[0].naturalHeight - image.height(); 
      return (widthDiff >= 0) || (heightDiff >= 0);
    }
  }

  window.ProductMediaSlider = ProductMediaSlider;

}(jQuery));

ProductMediaSlider.init();
</script>